{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.13", "generated_at": "2025-11-07T13:05:11.966131Z", "invocation_id": "feeb08f7-3aa9-4ef5-ac6c-413f32d08601", "invocation_started_at": "2025-11-07T13:05:01.697366Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-07T13:05:11.812044Z", "completed_at": "2025-11-07T13:05:11.841466Z"}, {"name": "execute", "started_at": "2025-11-07T13:05:11.843544Z", "completed_at": "2025-11-07T13:05:11.843561Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.034909963607788086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dbt_project.stg_orders__amazon_order_items", "compiled": true, "compiled_code": "-- stg_orders__amazon_order_items.sql\n\nwith\n\nsource as (\n\n    select * from `modern-sublime-383117`.`orders`.`amazon_order_items`\n\n),\n\nhandle_nulls as (\n\n    select\n        -- ids\n        asin,\n        tenant_id,\n        order_item_id,\n        promotion_ids,\n        amazon_order_id,\n\n        -- strings\n        title,\n        seller_sku,\n        marketplace,\n        tax_collection_model,\n        item_tax_currency_code,\n        item_price_currency_code,\n        shipping_tax_currency_code,\n        shipping_price_currency_code,\n        shipping_discount_currency_code,\n        promotion_discount_currency_code,\n        tax_collection_responsible_party,\n        shipping_discount_tax_currency_code,\n        promotion_discount_tax_currency_code,\n        buyer_info_gift_wrap_tax_currency_code,\n        buyer_info_gift_wrap_price_currency_code,\n\n        -- numerics\n        quantity_ordered,\n        quantity_shipped,\n        shipping_tax_amount,\n        shipping_price_amount,\n        shipping_discount_amount,\n        product_info_number_of_items,\n        shipping_discount_tax_amount,\n        buyer_info_gift_wrap_tax_amount,\n        buyer_info_gift_wrap_price_amount,\n\n        -- booleans\n        is_gift,\n        is_transparency,\n\n        -- dates and timestamps\n        created_at,\n        updated_at,\n\n        COALESCE(item_tax_amount, 0) as item_tax_amount,\n        COALESCE(item_price_amount, 0) as item_price_amount,\n        COALESCE(promotion_discount_amount, 0) as promotion_discount_amount,\n        COALESCE(promotion_discount_tax_amount, 0) as promotion_discount_tax_amount\n\n    from source\n\n)\n\nselect * from handle_nulls", "relation_name": "`modern-sublime-383117`.`dbt_cherry_staging`.`stg_orders__amazon_order_items`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-07T13:05:11.825508Z", "completed_at": "2025-11-07T13:05:11.843054Z"}, {"name": "execute", "started_at": "2025-11-07T13:05:11.843914Z", "completed_at": "2025-11-07T13:05:11.843922Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.03514528274536133, "adapter_response": {}, "message": null, "failures": null, "unique_id": "operation.dbt_project.dbt_project-on-run-start-0", "compiled": true, "compiled_code": "create schema if not exists dbt_cherry", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-07T13:05:11.902571Z", "completed_at": "2025-11-07T13:05:11.933937Z"}, {"name": "execute", "started_at": "2025-11-07T13:05:11.934706Z", "completed_at": "2025-11-07T13:05:11.934721Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.034510135650634766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dbt_project.int_add_fields_to_joined_orders", "compiled": true, "compiled_code": "-- int_add_fields_to_joined_orders.sql\n-- same as amazon_order_items_detailed_view\n\n\n\nwith\n\n __dbt__cte__int_join_orders_and_order_items as (\n-- int_join_orders_and_order_items.sql\n\n\n\nwith\n\norders as (\n\n    select * from `modern-sublime-383117`.`orders`.`amazon_orders`\n\n),\n\norder_items as (\n\n    select * from `modern-sublime-383117`.`dbt_cherry_staging`.`stg_orders__amazon_order_items`\n\n),\n\njoin_orders_and_order_items as (\n    select\n        o.amazon_order_id,\n        oi.order_item_id,\n        o.marketplace,\n        o.sales_channel,\n        oi.asin,\n        oi.seller_sku,\n        o.order_status,\n        oi.quantity_ordered,\n        oi.promotion_ids,\n        oi.product_info_number_of_items,\n        o.is_replacement_order,\n        oi.item_price_amount,\n        oi.item_price_currency_code,\n        oi.item_tax_amount,\n        oi.item_tax_currency_code,\n        oi.promotion_discount_tax_amount,\n        oi.promotion_discount_tax_currency_code,\n        oi.promotion_discount_amount,\n        oi.promotion_discount_currency_code,\n        oi.tax_collection_model,\n        oi.tax_collection_responsible_party,\n        o.is_prime,\n        o.replaced_order_id,\n        oi.is_gift,\n        o.tenant_id,\n        o.purchase_date,\n        oi.shipping_price_amount,\n        oi.shipping_price_currency_code,\n        oi.shipping_discount_amount,\n        oi.shipping_discount_currency_code,\n        oi.buyer_info_gift_wrap_price_amount,\n        oi.buyer_info_gift_wrap_price_currency_code\n\n    from orders as o\n\n    left join order_items as oi\n        on o.amazon_order_id = oi.amazon_order_id\n\n    order by o.purchase_date desc, o.tenant_id asc, o.marketplace desc, oi.seller_sku asc\n\n)\n\nselect * from join_orders_and_order_items\n),  __dbt__cte__int_calculate_fields_for_joined_orders as (\n-- int_calculate_fields_for_joined_orders.sql\n\n\n\nwith\n\njoined_orders as (\n\n    select * from __dbt__cte__int_join_orders_and_order_items\n\n),\n\ncalculate_fields as (\n\n    select\n        order_item_id,\n\n        -- purchase_date\n        purchase_date as purchase_datetime,\n        DATE(purchase_date) as purchase_date,\n\n        -- UK VAT of 20%\n        case\n            when marketplace = 'UK' and item_tax_amount > 0\n                then item_tax_amount\n            when marketplace = 'UK' and item_tax_amount = 0\n                then (item_price_amount / 1.20) * 0.20\n            else 0\n        end as output_vat,\n\n        -- Coupon Fee\n        case\n            when\n                promotion_ids like '%VPC%'\n                and marketplace in ('US', 'CA')\n                then 0.6\n            when\n                promotion_ids like '%VPC%'\n                and marketplace = 'UK'\n                then 0.45\n            when promotion_ids like '%PLM%'\n                then item_price_amount * 0.025\n            else 0\n        end as coupon_fee,\n\n        -- Determines if Vine order\n        case\n            when\n                order_status not in ('Pending', 'Canceled')\n                and item_price_amount is null\n                and is_replacement_order = false\n                and quantity_ordered > 0\n                then true\n            when\n                promotion_ids like '%vine%'\n                then true\n            else false\n        end as is_vine\n\n    from joined_orders\n\n)\n\nselect * from calculate_fields\n),  __dbt__cte__int_get_prime_exclusive_price_for_new_orders as (\n-- int_get_prime_exclusive_price_for_new_orders.sql\n\n\n\nwith\n\norders as (\n\n    select * from `modern-sublime-383117`.`orders`.`amazon_orders`\n\n),\n\norder_items as (\n\n    select * from `modern-sublime-383117`.`dbt_cherry_staging`.`stg_orders__amazon_order_items`\n\n),\n\ncompetitive_pricing as (\n\n    select * from `modern-sublime-383117`.`product_pricing`.`competitive_pricing`\n\n),\n\nprime_prices as (\n    select\n        asin,\n        marketplace,\n        (ARRAY_AGG(\n            JSON_EXTRACT_SCALAR(\n                product_competitive_pricing_competitive_prices,\n                '$[0].Price.ListingPrice.Amount'\n            ) order by date desc limit 1\n        ))[OFFSET(0)] as prime_price\n    from competitive_pricing\n    where\n        customer_type = 'Business'\n        and product_competitive_pricing_competitive_prices != '[]'\n    group by asin, marketplace\n),\n\nget_prime_exclusive_price as (\n\n    select\n        o.amazon_order_id,\n        oi.order_item_id,\n\n        case\n            when\n                o.order_status in ('Pending')\n                and oi.item_price_amount is null\n                and o.is_replacement_order = false\n                then\n                    CAST(pp.prime_price as numeric) * oi.quantity_ordered\n            else oi.item_price_amount\n        end as item_price_amount\n\n    from orders as o\n\n    left join order_items as oi\n        on o.amazon_order_id = oi.amazon_order_id\n\n    left join prime_prices as pp\n        on\n            oi.asin = pp.asin\n            and oi.marketplace = pp.marketplace\n\n)\n\nselect * from get_prime_exclusive_price\n), fields_to_add as (\n\n    select * from __dbt__cte__int_calculate_fields_for_joined_orders\n\n),\n\nwith_prime_exclusive_price as (\n\n    select * from __dbt__cte__int_get_prime_exclusive_price_for_new_orders\n\n),\n\njoined_orders as (\n\n    select * from __dbt__cte__int_join_orders_and_order_items\n\n),\n\nadd_fields_to_joined_orders as (\n\n    select\n        jo.amazon_order_id,\n        jo.order_item_id,\n        fta.purchase_datetime,\n        fta.purchase_date,\n        jo.marketplace,\n        jo.sales_channel,\n        jo.asin,\n        jo.seller_sku,\n        jo.order_status,\n        jo.quantity_ordered,\n        jo.promotion_ids,\n        jo.product_info_number_of_items,\n        jo.item_price_currency_code,\n        prime.item_price_amount,\n        jo.item_tax_amount,\n        jo.promotion_discount_tax_currency_code,\n        fta.output_vat,\n        jo.item_tax_currency_code,\n        jo.promotion_discount_tax_amount,\n        jo.promotion_discount_currency_code,\n        jo.promotion_discount_amount,\n        fta.coupon_fee,\n        jo.tax_collection_model,\n        jo.tax_collection_responsible_party,\n        jo.is_prime,\n        jo.is_replacement_order,\n        jo.replaced_order_id,\n        jo.is_gift,\n        fta.is_vine,\n        jo.tenant_id,\n        jo.shipping_price_amount,\n        jo.shipping_price_currency_code,\n        jo.shipping_discount_amount,\n        jo.shipping_discount_currency_code,\n        jo.buyer_info_gift_wrap_price_amount,\n        jo.buyer_info_gift_wrap_price_currency_code\n\n    from joined_orders as jo\n\n    left join fields_to_add as fta\n        on jo.order_item_id = fta.order_item_id\n\n    left join with_prime_exclusive_price as prime\n        on jo.order_item_id = prime.order_item_id\n\n    order by fta.purchase_datetime desc, jo.tenant_id asc, jo.marketplace desc, jo.seller_sku asc\n)\n\nselect * from add_fields_to_joined_orders", "relation_name": "`modern-sublime-383117`.`dbt_cherry_intermediate`.`int_add_fields_to_joined_orders`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-07T13:05:11.939687Z", "completed_at": "2025-11-07T13:05:11.947694Z"}, {"name": "execute", "started_at": "2025-11-07T13:05:11.948540Z", "completed_at": "2025-11-07T13:05:11.948548Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011387825012207031, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dbt_project.int_aggregate_joined_orders_with_added_fields", "compiled": true, "compiled_code": "-- int_aggregate_joined_orders_with_added_fields.sql\n\n\n\nwith\n\njoined_orders_with_added_fields as (\n\n    select * from `modern-sublime-383117`.`dbt_cherry_intermediate`.`int_add_fields_to_joined_orders`\n\n),\n\naggregate_joined_orders_with_added_fields as (\n\n    select\n        purchase_date,\n        marketplace,\n        order_status,\n        asin,\n        seller_sku,\n        item_price_currency_code,\n        is_vine,\n        is_replacement_order,\n        tenant_id,\n        REGEXP_EXTRACT(seller_sku, r'[^_]+$') as product_code,\n        SUM(quantity_ordered) as quantity_ordered,\n        SUM(item_price_amount) as item_price_amount,\n        SUM(promotion_discount_amount) as promotion_discount_amount,\n        SUM(item_tax_amount) as item_tax_amount,\n        SUM(shipping_price_amount) as shipping_price_amount,\n        SUM(shipping_discount_amount) as shipping_discount_amount,\n        SUM(buyer_info_gift_wrap_price_amount) as buyer_info_gift_wrap_price_amount,\n        SUM(output_vat) as output_vat,\n        SUM(coupon_fee) as coupon_fee,\n\n        -- Sales Price per unit, UK Sales have 20% VAT included\n        case\n            when marketplace = 'UK'\n                then\n                    ROUND(\n                        SAFE_DIVIDE(SUM(item_price_amount) - SUM(promotion_discount_amount) - SUM(coupon_fee) - SUM(output_vat), SUM(quantity_ordered)\n                        ), 2\n                    )\n            else\n                ROUND(\n                    SAFE_DIVIDE(SUM(item_price_amount) - SUM(promotion_discount_amount) - SUM(coupon_fee), SUM(quantity_ordered)\n                    ), 2\n                )\n        end as net_item_price_per_unit,\n\n        -- Sales Price per order, UK Sales have 20% VAT included\n        case\n            when marketplace = 'UK'\n                then\n                    SUM(item_price_amount) - SUM(promotion_discount_amount) - SUM(coupon_fee) - SUM(output_vat)\n            else\n                SUM(item_price_amount) - SUM(promotion_discount_amount) - SUM(coupon_fee)\n        end as net_item_price_amount,\n\n        -- Estimated Referral Fee Percentage\n        case\n            when tenant_id = 1\n                then 0.15\n            when tenant_id = 2\n                then\n                    case\n                        when\n                            REGEXP_CONTAINS(seller_sku, r'^R_CALF-SLEEV*') -- Calf Sleeves\n                            or REGEXP_CONTAINS(seller_sku, r'^R_GRIP-SOCKS*') -- Grip Socks\n                            or REGEXP_CONTAINS(seller_sku, r'^R_COMP-SOCKS*') -- Compression Socks\n                            or REGEXP_CONTAINS(seller_sku, r'^R_PF-SOCKS*') -- Plantar Socks\n                            then\n                                case\n                                    when marketplace = 'US'\n                                        then 0.05\n                                    when marketplace = 'UK'\n                                        then 0.08\n                                end\n                        when (\n                            REGEXP_CONTAINS(seller_sku, r'^R_KNEE-SLE*') -- Knee Sleeves\n                            or REGEXP_CONTAINS(seller_sku, r'^R_ELBO-SLE*') -- Elbow Sleeves\n                        )\n                        and (\n                            marketplace = 'US'\n                            or marketplace = 'UK'\n                        )\n                            then\n                                case\n                                    when REGEXP_CONTAINS(seller_sku, r'^*_2PC_*')\n                                        then 0.15\n                                    else 0.08\n                                end\n                        when\n                            REGEXP_CONTAINS(seller_sku, r'^R_HIKE-SOC*') -- Merino Wool Hiking Socks\n                            and marketplace = 'UK'\n                            then\n                                case\n                                    when REGEXP_CONTAINS(seller_sku, r'^*_3PR_*')\n                                        then 0.15\n                                    else 0.08\n                                end\n                    end\n        end as referral_fee_pct\n        -- SUM(item_price_amount) * 0.15 as referral_fees, -- old formula for Bare Barrel only\n\n    from joined_orders_with_added_fields\n\n    group by purchase_date, marketplace, asin, seller_sku, item_price_currency_code, is_vine, is_replacement_order, tenant_id, order_status\n\n    order by purchase_date desc, marketplace desc, quantity_ordered desc\n),\n\nadd_referral_fees as (\n\n    select\n        purchase_date,\n        marketplace,\n        order_status,\n        asin,\n        seller_sku,\n        item_price_currency_code,\n        is_vine,\n        is_replacement_order,\n        tenant_id,\n        product_code,\n        quantity_ordered,\n        item_price_amount,\n        promotion_discount_amount,\n        item_tax_amount,\n        output_vat,\n        coupon_fee,\n        net_item_price_per_unit,\n        net_item_price_amount,\n        referral_fee_pct,\n        referral_fee_pct * (net_item_price_amount + shipping_price_amount - shipping_discount_amount + buyer_info_gift_wrap_price_amount)\n            as referral_fees\n    from aggregate_joined_orders_with_added_fields\n)\n\nselect * from add_referral_fees", "relation_name": "`modern-sublime-383117`.`dbt_cherry_intermediate`.`int_aggregate_joined_orders_with_added_fields`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-07T13:05:11.953063Z", "completed_at": "2025-11-07T13:05:11.960369Z"}, {"name": "execute", "started_at": "2025-11-07T13:05:11.961148Z", "completed_at": "2025-11-07T13:05:11.961162Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.010473966598510742, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dbt_project.obt_orders_per_asin_and_date", "compiled": true, "compiled_code": "-- obt_orders_per_asin_and_date.sql\n-- same as amazon_orders_summary_view\n\nwith\n\naggregated_joined_orders as (\n\n    select * from `modern-sublime-383117`.`dbt_cherry_intermediate`.`int_aggregate_joined_orders_with_added_fields`\n\n),\n\nreorder_fields as (\n\n    select\n        purchase_date,\n        marketplace,\n        order_status,\n        asin,\n        seller_sku,\n        product_code,\n        quantity_ordered,\n        net_item_price_per_unit,\n        item_price_amount,\n        promotion_discount_amount,\n        item_tax_amount,\n        output_vat,\n        net_item_price_amount,\n        referral_fees,\n        coupon_fee,\n        item_price_currency_code,\n        is_vine,\n        is_replacement_order,\n        tenant_id\n\n    from aggregated_joined_orders\n\n    order by purchase_date desc, marketplace desc, quantity_ordered desc\n)\n\nselect * from reorder_fields", "relation_name": "`modern-sublime-383117`.`dbt_cherry_marts`.`obt_orders_per_asin_and_date`", "batch_results": null}], "elapsed_time": 2.587233066558838, "args": {"send_anonymous_usage_stats": true, "project_dir": "/Users/cherry/Documents/Work/Bare Barrel Ltd/dbt_project", "profiles_dir": "/Users/cherry/.dbt", "strict_mode": false, "log_file_max_bytes": 10485760, "require_batched_execution_for_custom_microbatch_strategy": false, "introspect": true, "indirect_selection": "eager", "partial_parse_file_diff": true, "populate_cache": true, "cache_selected_only": false, "require_resource_names_without_spaces": true, "use_fast_test_edges": false, "warn_error_options": {"error": [], "warn": [], "silence": []}, "version_check": true, "state_modified_compare_vars": false, "require_nested_cumulative_type_params": false, "invocation_command": "dbt compile", "printer_width": 80, "favor_state": false, "skip_nodes_if_on_run_start_fails": false, "source_freshness_run_project_hooks": true, "use_colors_file": true, "log_level": "info", "exclude": [], "log_path": "/Users/cherry/Documents/Work/Bare Barrel Ltd/dbt_project/logs", "require_generic_test_arguments_property": true, "use_colors": true, "inject_ephemeral_ctes": true, "empty": false, "require_yaml_configuration_for_mf_time_spines": false, "print": true, "static_parser": true, "output": "text", "partial_parse": true, "log_level_file": "debug", "defer": false, "validate_macro_args": false, "write_json": true, "select": [], "macro_debugging": false, "state_modified_compare_more_unrendered_values": false, "show_resource_report": false, "show_all_deprecations": false, "quiet": false, "require_explicit_package_overrides_for_builtin_materializations": true, "vars": {}, "which": "compile", "upload_to_artifacts_ingest_api": false, "log_format_file": "debug", "log_format": "default", "require_all_warnings_handled_by_warn_error": false}}